version: 2.1
description: |
  Run your Cypress.io end-to-end & component tests without spending time configuring CircleCI.
  This orb can also record results on the Cypress Dashboard and load balance tests in parallel mode.
  If recording on the dashboard, set `CYPRESS_RECORD_KEY` as CI environment variable.

display:
  source_url: https://github.com/cypress-io/circleci-orb
  home_url: https://www.cypress.io

#
# See https://www.cypress.io/
#
# User workflows can use "Jobs" defined in this Orb
# Jobs can use "Commands" also defined in this Orb
# Commands run on "Executors" defined below to guarantee consistent environment
# with all dependencies installed correctly.

#
# environments (containers) for running jobs and commands
#
executors:
  default:
    description: |
      Single Docker container with Cypress dependencies,
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base
    parameters:
      node:
        type: string
        default: '12.14.0'
        description: Version of Node 6/8/10/12.x to use
    docker:
      - image: cypress/base:<< parameters.node >>

  # executors based on available Cypress docker images
  # see https://github.com/cypress-io/cypress-docker-images
  # see https://hub.docker.com/r/cypress/base/tags
  base-6:
    # deprecated
    description: Single Docker container with Node 6 and Cypress dependencies
    docker:
      - image: cypress/base:6

  base-8:
    # deprecated
    description: Single Docker container with Node 8 and Cypress dependencies
    docker:
      - image: cypress/base:8

  # base:10 tag that can change
  base-10:
    description: |
      Single Docker container with Node 10 and Cypress dependencies, pointing
      at the Docker image `cypress/base:10` tag.
      Use example: `executor: cypress/base-10`.
      DEPRECATED
    docker:
      - image: cypress/base:10

  base-10-22-0:
    description: |
      Single Docker container pointing at the immutable `cypress/base:10.22.0` image.
    docker:
      - image: cypress/base:10.22.0

  # specific immutable Node 12 images
  base-12-6-0:
    description: |
      Single Docker container with Node 12.6.0 and Cypress dependencies
      Use example: `executor: cypress/base-12-6-0`.
    docker:
      - image: cypress/base:12.6.0

  base-12-14-0:
    description: |
      Single Docker container with Node 12.14.0 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-12-14-0`.
    docker:
      - image: cypress/base:12.14.0

  base-12-16-1:
    description: |
      Single Docker container with Node 12.16.1 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-12-16-1`.
    docker:
      - image: cypress/base:12.16.1

  base-12-18-3:
    description: |
      Single Docker container with Node 12.18.3 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-12-18-3`.
    docker:
      - image: cypress/base:12.18.3

  # the latest Node 12 tag image
  base-12:
    description: |
      Single Docker container with the latest Node v12 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-12`.
    docker:
      - image: cypress/base:12.19.0

  # immutable Node 14.x images
  base-14-0-0:
    description: |
      Single Docker container with Node 14.0.0 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-14-0-0`.
    docker:
      - image: cypress/base:14.0.0

  base-14-7-0:
    description: |
      Single Docker container with Node 14.7.0 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-14-7-0`.
    docker:
      - image: cypress/base:14.7.0

  # latest Node 14 tag images from Cypress
  base-14:
    description: |
      Single Docker container with the latest Node v14 and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-14`.
    docker:
      - image: cypress/base:14

  base-16-14-2-slim:
    description: |
      Single Docker container with Node 16.14.2-slim and Cypress dependencies
      see https://github.com/cypress-io/cypress-docker-images/tree/master/base.
      Use example: `executor: cypress/base-16-14-2-slim`.
    docker:
      - image: cypress/base:16.14.2-slim

  browsers-chrome69:
    description: Docker container with Node 10, Cypress dependencies and Chrome 69
    docker:
      - image: cypress/browsers:chrome69

  browsers-chrome73:
    description: Docker container with Node 11.13.0, Cypress dependencies and Chrome 73
    docker:
      - image: cypress/browsers:node11.13.0-chrome73

  browsers-chrome74:
    description: Docker container with Node 10.1.2, Cypress dependencies and Chrome 74
    docker:
      - image: cypress/browsers:node10.2.1-chrome74

  browsers-chrome75:
    description: Docker container with Node 12.6.0, Cypress dependencies and Chrome 75
    docker:
      - image: cypress/browsers:node12.6.0-chrome75

  browsers-chrome76:
    description: Docker container with Node 10.16.0, Cypress dependencies and Chrome 76
    docker:
      - image: cypress/browsers:node10.16.0-chrome76

  browsers-chrome77:
    description: Docker container with Node 12.6.0, Cypress dependencies and Chrome 77
    docker:
      - image: cypress/browsers:node12.6.0-chrome77

  browsers-chrome78-ff70:
    description: |
      Docker container with Node 12.13.0, Cypress dependencies and Chrome 78 and Firefox 70.
      Use example: `executor: cypress/browsers-chrome78-ff70`.
    docker:
      - image: cypress/browsers:node12.13.0-chrome78-ff70

  browsers-chrome73-ff68:
    description: Docker container with Node 12.0.0, Cypress dependencies, Chrome 73 and Firefox 68.0.2
    docker:
      - image: cypress/browsers:node12.0.0-chrome73-ff68

  browsers-chrome99-ff97:
    description: Docker container with Node 16.14.0, Cypress dependencies, Chrome 99 and Firefox 97
    docker:
      - image: cypress/browsers:node16.14.0-chrome99-ff97

  browsers-chrome100-ff99-edge:
    description: Docker container with Node 16.14.2, Cypress dependencies, Chrome 100, Firefox 99, and the latest Edge
    docker:
      - image: cypress/browsers:node16.14.2-slim-chrome100-ff99-edge

#
# reusable commands
#
commands:
  #
  # individual "building blocks" commands
  #
  setup:
    description: |
      Command to do "npm ci" or "yarn" or custom command (maybe)
    parameters:
      executor:
        description: Executor to use, by default Node 12 LTS
        type: executor
        default: base-12
      post-install:
        description: |
          Additional commands to run after running install
          but before verifying Cypress and saving cache.
        type: steps
        default: []
      build:
        description: Optional build command
        type: string
        default: ''
      install-command:
        description: Overrides the default NPM or Yarn command
        type: string
        default: ''
      verify-command:
        description: Overrides the default NPM or Yarn command to verify Cypress
        type: string
        default: 'npx cypress verify'
      yarn:
        description: Use yarn instead of npm
        type: boolean
        default: false
      cache-key:
        description: Npm cache key
        type: string
        default: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}'
      working_directory:
        description: Directory containing package.json
        type: string
        default: ''
    steps:
      - restore_cache:
          keys:
            - << parameters.cache-key >>
      # we can install dependencies using "NPM CI", or "Yarn" or the
      # user-supplies custom command. Because of orb template expressions
      # being very limited, have to do this as a single script
      - run:
          name: Install
          working_directory: << parameters.working_directory >>
          command: |
            if [[ ! -z "<< parameters.install-command >>" ]]; then
              echo "Installing using custom command"
              echo "<< parameters.install-command >>"
              << parameters.install-command >>
            elif [ "<< parameters.yarn >>" = "true" ]; then
              echo "Installing using Yarn"
              yarn install --frozen-lockfile
            elif [ ! -e ./package-lock.json ]; then
              echo "The Cypress orb uses 'npm ci' to install 'node_modules', which requires a 'package-lock.json'."
              echo "A 'package-lock.json' file was not found. Please run 'npm install' in your project,"
              echo "and commit 'package-lock.json' to your repo."
              exit 1
            else
              echo "Installing dependencies using NPM ci"
              npm ci
            fi
      - steps: << parameters.post-install >>
      - run:
          name: 'Verify Cypress'
          command: << parameters.verify-command >>
          working_directory: << parameters.working_directory >>
      # save new cache folder if needed
      - when:
          condition: << parameters.yarn >>
          steps:
            - save_cache:
                key: << parameters.cache-key >>
                paths:
                  - ~/.cache
      - unless:
          condition: << parameters.yarn >>
          steps:
            - save_cache:
                key: << parameters.cache-key >>
                paths:
                  - ~/.npm
                  - ~/.cache
      - when:
          condition: << parameters.build >>
          steps:
            - run:
                name: 'Build'
                command: << parameters.build >>
                working_directory: << parameters.working_directory >>

  write_workspace:
    steps:
      - persist_to_workspace:
          root: ~/
          paths:
            - project
            - .cache/Cypress

  #
  # public user commands
  #

  # Install command
  install:
    description: |
      Install NPM dependencies using "npm ci" or "yarn install --frozen-lockfile" then optionally runs your build command
    parameters:
      post-install:
        description: |
          Additional commands to run after running install
          but before verifying Cypress and saving cache.
        type: steps
        default: []
      build:
        type: string
        default: ''
        description: Custom build command to run after install
      yarn:
        description: Use yarn instead of npm
        type: boolean
        default: false
      cache-key:
        description: Npm cache key
        type: string
        default: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}'
      no-workspace:
        description: |
          Do not write workspace (for example if there are no jobs to follow)
        type: boolean
        default: false
      working_directory:
        description: Directory containing package.json
        type: string
        default: ''
      install-command:
        description: Overrides the default NPM or Yarn command
        type: string
        default: ''
      verify-command:
        description: Overrides the default NPM or Yarn command to verify Cypress
        type: string
        default: 'npx cypress verify'
    steps:
      - setup:
          install-command: << parameters.install-command >>
          verify-command: << parameters.verify-command >>
          post-install: << parameters.post-install >>
          yarn: << parameters.yarn >>
          cache-key: << parameters.cache-key >>
          build: << parameters.build >>
          working_directory: << parameters.working_directory >>
      - unless:
          condition: << parameters.no-workspace >>
          steps:
            - write_workspace

#
# jobs defined by the orb
#
jobs:
  # a single e2e test run that
  #   - checks out code
  #   - installs NPM dependencies
  #     * (optional) run custom build command
  #   - executes Cypress end-to-end tests
  #     * (optional) starts server in the background
  #     * (optional) records tests results on Cypress Dashboard:
  #       - (optional) splits tests across N machines
  #       - (optional) names tests with a group name
  #       - (optional) use custom run tests command
  run:
    description:
      A single complete job to run Cypress end-to-end tests in your project.
      If recording on the Dashboard, set `CYPRESS_RECORD_KEY` environment variable

    parameters:
      executor:
        type: executor
        default: base-12
        description: |
          Cypress executor to use, see [executors.md](executors.md).
          You can define your own executor, see examples.

      debug:
        type: string
        default: ''
        description: Debug value to set as the DEBUG environment variable before running tests

      post-checkout:
        description: Additional commands to run after performing Git checkout
        type: steps
        default: []

      record:
        type: boolean
        default: false
        description: |
          Record results on Cypress Dashboard, see https://on.cypress.io/dashboard-service.
          This option is necessary to enable other related flags, like `parallel` and `group`.

      # "parallel" parameter should be used with "parallelism" parameter
      parallel:
        type: boolean
        default: false
        description: |
          Use test balancing using Cypress Dashboard,
          see https://on.cypress.io/parallelization. Requires `record: true` and
          only makes sense with CircleCI `parallelism` setting to spin several CI machines.
          Related options "record" and "group".

      parallelism:
        type: integer
        default: 1
        description: |
          Number of Circle machines to use for load balancing, min 1
          (requires "parallel" parameter set to true, and requires `record: true`)

      ci-build-id:
        type: string
        default: ''
        description: |
          A common unique ID that ties multiple test jobs into a single logical run.
          See Cypress [parallelization docs](https://on.cypress.io/parallelization).
          See usage example in [circleci-orb-parallel-example](https://github.com/cypress-io/circleci-orb-parallel-example).

      group:
        type: string
        default: ''
        description: |
          Test group name when recording on the dashboard. Requires `record: true`

      tags:
        type: string
        default: ''
        description: |
          Comma-separated tags to send to the dashboard. Requires `record: true`

      post-install:
        description: |
          Additional commands to run after running install
          but before verifying Cypress and saving cache.
        type: steps
        default: []

      build:
        type: string
        default: ''
        description: |
          Custom build command to run after install to build your application.
          Related parameter "start"

      start:
        type: string
        default: ''
        description: |
          Optional server start command to run in the background before running Cypress tests.
          Related parameters "build" and "wait-on".

      wait-on:
        type: string
        default: ''
        description: |
          Optional url check using `wait-on` utility. Useful to delay tests until server boots and responds.
          Example:
            wait-on: "http://localhost:4200" # wait for local port 4200 to respond to HEAD request
            wait-on: "http-get://127.0.0.1:3000" # wait for port 3000 to respond to GET request

      browser:
        type: string
        default: ''
        description: |
          Browser to use to run end-to-end tests. Typically "electron" (default) or "chrome".
          See https://on.cypress.io/launching-browsers, requires using executor with the browser installed,
          electron browser is already included with Cypress.

      spec:
        type: string
        default: ''
        description: |
          Spec pattern to use to run only some test files, passed as `--spec ...` CLI argument.

      install-command:
        description: Overrides the default NPM or Yarn command
        type: string
        default: ''

      verify-command:
        description: Overrides the default NPM or Yarn command to verify Cypress
        type: string
        default: 'npx cypress verify'

      command:
        type: string
        default: ''
        description: |
          Custom test command to run Cypress tests, which overrides all individual options.

      command-prefix:
        type: string
        default: ''
        description: |
          Custom prefix for the default test command.

      store_artifacts:
        type: boolean
        default: false
        description: |
          Store Cypress-generated screenshots and videos as CircleCI test artifacts.
          See https://circleci.com/docs/2.0/artifacts/

      yarn:
        description: Use yarn to install NPM modules instead of npm.
        type: boolean
        default: false

      cache-key:
        description: |
          Custom CircleCI cache key for storing NPM modules and Cypress binary.
        type: string
        default: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}'

      attach-workspace:
        description: |
          Assuming there was an install job before, first attach
          the workspace to avoid re-installing dependencies
        type: boolean
        default: false

      no-workspace:
        description: |
          Do not write workspace after this job is done.
          This is useful if there are no jobs to follow,
          which saves time on each build.
        type: boolean
        default: false

      working_directory:
        description: |
          Directory containing package.json. Use this parameter if you're using a monorepo and your
          cypress tests aren't at the root of the repository (eg. `frontend`).
        type: string
        default: ''

      timeout:
        description: Optional timeout for running tests
        type: string
        default: 10m

      config-file:
        description: Name of the Cypress configuration file to use
        type: string
        default: ''

      config:
        description: Additional configuration values to pass using --config
        type: string
        default: ''

      env:
        description: Values to pass using --env argument
        type: string
        default: ''

      component:
        description: Runs component tests using --component
        type: boolean
        default: false

    executor: <<parameters.executor>>
    parallelism: <<parameters.parallelism>>

    # be explicit about setting cache folder
    # https://github.com/cypress-io/circleci-orb/issues/98
    environment:
      CYPRESS_CACHE_FOLDER: ~/.cache/Cypress

    steps:
      - when:
          condition: << parameters.debug >>
          # user sets custom DEBUG string, we need to set it as an environment variable
          # https://circleci.com/docs/2.0/env-vars/
          steps:
            - run:
                name: Export DEBUG variable
                command: |
                  echo 'export DEBUG="<< parameters.debug >>"' >> $BASH_ENV

      - when:
          condition:
            or: [ << parameters.parallel >>, << parameters.attach-workspace >> ]
          # user wants to run in parallel mode
          # thus we assume the dependencies were installed as separate job
          # hmm, can we detect if this job requires cypress/install automatically?
          steps:
            - run: echo "Assuming dependencies were installed using cypress/install job"
            - attach_workspace:
                at: ~/

      - unless:
          condition: << parameters.parallel >>
          steps:
            - when:
                condition: << parameters.attach-workspace >>
                steps:
                  - when:
                      condition: << parameters.build >>
                      steps:
                        - run:
                            name: Build 🏗
                            command: <<parameters.build>>
                            working_directory: << parameters.working_directory >>

            - unless:
                condition: << parameters.attach-workspace >>
                steps:
                  - checkout
                  - steps: << parameters.post-checkout >>
                  - when:
                      condition: << parameters.build >>
                      steps:
                        - install:
                            yarn: << parameters.yarn >>
                            install-command: << parameters.install-command >>
                            verify-command: << parameters.verify-command >>
                            post-install: << parameters.post-install >>
                            cache-key: << parameters.cache-key >>
                            no-workspace: << parameters.no-workspace >>
                            build: << parameters.build >>
                            working_directory: << parameters.working_directory >>
                  - unless:
                      condition: <<parameters.build>>
                      steps:
                        - install:
                            cache-key: << parameters.cache-key >>
                            yarn: << parameters.yarn >>
                            install-command: << parameters.install-command >>
                            verify-command: << parameters.verify-command >>
                            post-install: << parameters.post-install >>
                            no-workspace: << parameters.no-workspace >>
                            working_directory: << parameters.working_directory >>

      - when:
          condition: <<parameters.start>>
          steps:
            - run:
                name: Start
                command: <<parameters.start>>
                background: true
                working_directory: << parameters.working_directory >>

      - when:
          condition: <<parameters.wait-on>>
          steps:
            - run:
                name: Wait-on <<parameters.wait-on>>
                command: npx wait-on <<parameters.wait-on>>

      - when:
          condition: <<parameters.command>>
          steps:
            - run:
                name: Run Cypress tests using custom command
                command: <<parameters.command>>
                no_output_timeout: <<parameters.timeout>>
                working_directory: << parameters.working_directory >>

      - unless:
          condition: <<parameters.command>>
          steps:
            - when:
                condition: <<parameters.command-prefix>>
                steps:
                  - run:
                      name: Run Cypress tests prefixed
                      no_output_timeout: <<parameters.timeout>>
                      # GOOD EXAMPLE conditional text based on boolean parameter
                      # --record is needed to pass many other arguments, like "--group" and "--parallel"
                      command: |
                        <<parameters.command-prefix>> cypress run \
                          <<# parameters.spec>> --spec '<<parameters.spec>>' <</ parameters.spec>> \
                          <<# parameters.browser>> --browser <<parameters.browser>> <</ parameters.browser>> \
                          <<# parameters.config-file>> --config-file <<parameters.config-file>> <</ parameters.config-file>> \
                          <<# parameters.config>> --config <<parameters.config>> <</ parameters.config>> \
                          <<# parameters.env>> --env <<parameters.env>> <</ parameters.env>> \
                          <<# parameters.component>> --component <</ parameters.component>> \
                          <<# parameters.record >> --record \
                            <<# parameters.group>> --group '<<parameters.group>>' <</ parameters.group>> \
                            <<# parameters.parallel>> --parallel <</ parameters.parallel>> \
                            <<# parameters.tags>> --tag '<<parameters.tags>>' <</ parameters.tags>> \
                            <<# parameters.ci-build-id>> --ci-build-id <<parameters.ci-build-id>> <</ parameters.ci-build-id>> \
                          <</ parameters.record>>
                      working_directory: << parameters.working_directory >>
            - unless:
                condition: <<parameters.command-prefix>>
                steps:
                  - run:
                      name: Run Cypress tests
                      no_output_timeout: <<parameters.timeout>>
                      # GOOD EXAMPLE conditional text based on boolean parameter
                      # --record is needed to pass many other arguments, like "--group" and "--parallel"
                      command: |
                        npx cypress run \
                          <<# parameters.spec>> --spec '<<parameters.spec>>' <</ parameters.spec>> \
                          <<# parameters.browser>> --browser <<parameters.browser>> <</ parameters.browser>> \
                          <<# parameters.config-file>> --config-file <<parameters.config-file>> <</ parameters.config-file>> \
                          <<# parameters.config>> --config <<parameters.config>> <</ parameters.config>> \
                          <<# parameters.env>> --env <<parameters.env>> <</ parameters.env>> \
                          <<# parameters.component>> --component <</ parameters.component>> \
                          <<# parameters.record >> --record \
                            <<# parameters.group>> --group '<<parameters.group>>' <</ parameters.group>> \
                            <<# parameters.parallel>> --parallel <</ parameters.parallel>> \
                            <<# parameters.tags>> --tag '<<parameters.tags>>' <</ parameters.tags>> \
                            <<# parameters.ci-build-id>> --ci-build-id <<parameters.ci-build-id>> <</ parameters.ci-build-id>> \
                          <</ parameters.record>>
                      working_directory: << parameters.working_directory >>

      - when:
          condition: << parameters.store_artifacts >>
          # store videos and screenshots (if any) as Circle artifacts
          # https://circleci.com/docs/2.0/artifacts/
          steps:
            - when:
                condition: << parameters.working_directory >>
                steps:
                  # store artifacts does not understand working directory
                  # thus we need to form full folder names ourselves
                  - store_artifacts:
                      path: << parameters.working_directory >>/cypress/videos
                  - store_artifacts:
                      path: << parameters.working_directory >>/cypress/screenshots
            - unless:
                # no custom working directory
                condition: << parameters.working_directory >>
                steps:
                  - store_artifacts:
                      path: cypress/videos
                  - store_artifacts:
                      path: cypress/screenshots

  # Install Job that can be performed before running jobs
  # often used to have a single installation step, and then
  # multiple run jobs can share the same pre-installed workspace.
  install:
    parameters:
      executor:
        type: executor
        default: base-12
        description: Cypress or custom executor name to use to run the install.
      post-checkout:
        description: Additional commands to run after performing Git checkout
        type: steps
        default: []
      post-install:
        description: |
          Additional commands to run after running install
          but before verifying Cypress and saving cache.
        type: steps
        default: []
      build:
        type: string
        default: ''
        description: |
          Custom build command to run after install to build the web application or web server.
      cache-key:
        description: Npm cache key
        type: string
        default: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "package.json" }}'
      yarn:
        description: Use yarn to install NPM modules instead of npm.
        type: boolean
        default: false
      install-command:
        description: Overrides the default NPM or Yarn command
        type: string
        default: ''
      verify-command:
        description: Overrides the default NPM or Yarn command to verify Cypress
        type: string
        default: 'npx cypress verify'
      working_directory:
        description: |
          Directory containing package.json. Use this parameter if you're using a monorepo and your
          cypress tests aren't at the root of the repository (eg. `frontend`). Additionally,
          monorepo users will want to provide a `cache-key` parameter to key the cache with an
          appropriate checksum. (i.e. `cache-key: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "frontend/package.json" }}'`)
        type: string
        default: ''
    description: |
      Checks out code, installs dependencies, attaches code to the workspace for the future jobs
      to use (usually `cypress/run` follows the install step).
    executor: <<parameters.executor>>
    # be explicit about setting cache folder
    # https://github.com/cypress-io/circleci-orb/issues/98
    environment:
      CYPRESS_CACHE_FOLDER: ~/.cache/Cypress
    steps:
      - checkout
      - steps: << parameters.post-checkout >>
      - when:
          condition: << parameters.build >>
          steps:
            - install:
                install-command: << parameters.install-command >>
                verify-command: << parameters.verify-command >>
                yarn: << parameters.yarn >>
                post-install: << parameters.post-install >>
                build: << parameters.build >>
                working_directory: << parameters.working_directory >>
                cache-key: << parameters.cache-key >>
      - unless:
          condition: << parameters.build >>
          steps:
            - install:
                install-command: << parameters.install-command >>
                verify-command: << parameters.verify-command >>
                yarn: << parameters.yarn >>
                post-install: << parameters.post-install >>
                working_directory: << parameters.working_directory >>
                cache-key: << parameters.cache-key >>

#
# User examples showing how to use the above Cypress Orb
#
examples:
  simple:
    description: |
      Runs all Cypress tests without recording results on the Dashboard.
      Installs dependencies with "npm ci", caches NPM modules and Cypress binary.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run

  component-tests:
    description: |
      Runs all Cypress component tests without recording results on the Dashboard.
      Installs dependencies with "npm ci", caches NPM modules and Cypress binary.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@1.30.0
      workflows:
        build:
          jobs:
            - cypress/run:
                component: true

  yarn:
    description: |
      Installs NPM dependencies using "yarn install --frozen-lockfile" command,
      then runs Cypress tests. Caches NPM modules and Cypress binary.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                yarn: true

  custom-install:
    description: |
      Install dependencies using your own custom command.
      Related parameter: [custom-verify](#custom-verify)
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                install-command: 'yarn install --frozen-lockfile'

  custom-verify:
    description: |
      Verify Cypress was installed using custom command. Default command is "npx cypress verify"
      Related parameter: [custom-install](#custom-install)
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                verify-command: 'yarn cypress verify'

  custom-directory:
    description: |
      Runs all commands in a custom directory, this is useful when using a monorepo where
      the `package.json` file isn't at the root of the repository
      (eg. in the `frontend/subfolder`).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                yarn: true
                working_directory: frontend

  custom-cache-key:
    description: |
      Apply custom key for npm install (or yarn install) cache.
      Useful to tweak caching settings to your liking. Related options [yarn](#yarn).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                yarn: true
                cache-key: yarn-packages-{{ arch }}-{{ checksum "yarn.lock" }}

  custom-cache-and-directory:
    description: |
      Monorepo users may want to provide a `cache-key` parameter to key the cache
      with an appropriate checksum.
      (i.e. `cache-key: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "frontend/package.json" }}'`)
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install:
                cache-key: cache-{{ arch }}-{{ .Branch }}-{{ checksum "frontend/package.json" }}
            - cypress/run:
                yarn: true
                cache-key: cache-{{ arch }}-{{ .Branch }}-{{ checksum "frontend/package.json" }}
                working_directory: frontend

  using-node14:
    description: |
      Runs all Cypress tests on Node 14 image by specifying `executor` name.
      There are [several executors included](https://circleci.com/developer/orbs/orb/cypress-io/cypress#executors)
      with this orb or you can use your own executor, such as a Docker image
      from [cypress-docker-images](https://github.com/cypress-io/cypress-docker-images).
      See [custom-executor](#custom-executor) example.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                executor: cypress/base-14

  recording:
    description: |
      Runs all Cypress tests and records them on the
      [Cypress Dashboard](https://on.cypress.io/dashboard-service).
      Requires `CYPRESS_RECORD_KEY` environment variable to be set.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                record: true

  artifacts:
    description: |
      Stores test screenshots and videos as CircleCI artifacts using "store_artifacts" job option.
      Note, this setting assumes the default Cypress folders for screenshots and videos.
      If you store screenshots and videos in custom folders, see [any-artifacts](#any-artifacts) example how
      to store arbitrary folders.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                store_artifacts: true

  any-artifacts:
    description: |
      Stores additional folders like "mochawesome-report" or code coverage folder
      as a CircleCI artifact. Related option [artifacts](#artifacts).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                post-steps:
                  - store_artifacts:
                      path: mochawesome-report

  chrome:
    description: |
      Runs tests on Chrome in a [custom-executor](#custom-executor) - a Docker image
      that includes the Chrome browser, such as a Docker image from
      [cypress-docker-images](https://github.com/cypress-io/cypress-docker-images).
      See [`--browser`](https://on.cypress.io/launching-browsers) documentation for available browser arguments.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      executors:
        with-chrome:
          docker:
            - image: 'cypress/browsers:node14.16.0-chrome90-ff88'
      workflows:
        build:
          jobs:
            - cypress/run:
                executor: with-chrome
                browser: chrome

  start-server:
    description: |
      Often we need to start a local webserver before running end-to-end tests.
      This option runs the given command to starts the server in the background
      and then runs all Cypress tests. Related option [wait-on](#wait-for-server-to-respond).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                start: 'npm start'

  wait-for-server-to-respond:
    description: |
      Starts server, waits for it to respond and then runs all Cypress tests.
      Uses `npx wait-on ...` command under the hood, see [wait-on](https://github.com/jeffbski/wait-on#readme).
      Note, if you are using Webpack server, it might not respond to the default HTTP OPTIONS request.
      In that case use `wait-on` to send `HTTP GET` request by using url `wait-on: 'http-get://localhost:....'`.
      You can also pass `wait-on` config, see [issue #90](https://github.com/cypress-io/circleci-orb/issues/90).
      Related option [start](#start).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                start: 'npm start'
                wait-on: 'http://localhost:4200'

  parallel-on-2-machines:
    description: |
      Runs all Cypress tests by load balancing them on two machines. Note that
      first a single job installs NPM dependencies, then 2 jobs run the tests
      in parallel using Cypress Dashboard [parallelization](https://on.cypress.io/parallelization).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install
            - cypress/run:
                requires:
                  - cypress/install
                record: true
                parallel: true
                parallelism: 2
                group: '2 machines'

  custom-build-id:
    description: |
      Runs two jobs splitting the specs in parallel using
      Cypress Dashboard [parallelization](https://on.cypress.io/parallelization).
      Uses custom build ID to link the jobs together into a logical run.
      Notice the environment variable syntax to be expanded at the build time.
      See example in https://github.com/cypress-io/circleci-orb-parallel-example.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install
            - cypress/run:
                requires:
                  - cypress/install
                record: true
                parallel: true
                parallelism: 2
                ci-build-id: testing-commit-${CIRCLE_SHA1}

  install-private-npm-modules:
    description: |
      In this example, we write the NPM auth token before running "npm install" command.
      This allows us to install private NPM modules for example.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install:
                pre-steps:
                  - run: echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc
            - cypress/run:
                requires:
                  - cypress/install

  build-app:
    description: |
      Install dependencies and run a custom build command on one machine that builds the
      web application. Then runs Cypress tests on 3 machines and balances them using
      [Dashboard parallelization](https://on.cypress.io/parallelization).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install:
                build: 'npm run build' # custom build command
            - cypress/run:
                requires:
                  - cypress/install
                record: true
                parallel: true
                parallelism: 3
                group: '3x'

  groups:
    description: |
      Runs all tests on 4 machines using Electron browser (default).
      Also runs some tests using "spec" parameter on Chrome browser.
      Records both groups on Cypress dashboard. Notice "name" under each "cypress/run" job
      which will be shown in the Circle workflow UI to tell jobs apart.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install
            - cypress/run:
                name: '4 machines'
                requires:
                  - cypress/install
                record: true
                parallel: true
                parallelism: 4
                group: '4 machines'
            - cypress/run:
                name: 'Chrome'
                requires:
                  - cypress/install
                executor: cypress/browsers-chrome69
                record: true
                parallel: true
                parallelism: 2
                group: 'smoke tests'
                browser: 'chrome'
                spec: 'cypress/integration/smoke/*'

  release:
    description: |
      If you want to run an entire job after running Cypress tests, you can
      reuse the workspace from the `cypress/run` job. For example,
      to run a semantic release script you could follow this example.
      Note - for simpler steps you can use "post-steps" parameter, see [store-test-reports](#store-test-reports) example.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      jobs:
        release:
          executor: cypress/base-10
          steps:
            # the workspace saved by cypress/install
            - attach_workspace:
                at: ~/
            - run: npm run semantic-release
      workflows:
        build:
          jobs:
            - cypress/install
            - cypress/run:
                requires:
                  - cypress/install
            - release:
                requires:
                  - cypress/run

  linux-and-mac:
    description: |
      Runs tests on Linux and on Mac via two jobs.
      Note how the user defines and uses own [custom executor](#custom-executor) "mac".
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2

      executors:
        mac:
          macos:
            xcode: '10.1.0'

      workflows:
        build:
          jobs:
            - cypress/run:
                name: Linux test
            - cypress/run:
                name: Mac test
                executor: mac

  custom-executor:
    description: |
      Use any executor to run the job defined by the orb, such as a custom
      Docker image name, or a Docker image from [cypress-docker-images](https://github.com/cypress-io/cypress-docker-images).
      Assumes the executor has all OS dependencies necessary to run Cypress.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2

      executors:
        with-chrome:
          docker:
            - image: 'cypress/browsers:node14.16.0-chrome90-ff88'

      workflows:
        build:
          jobs:
            - cypress/run:
                executor: with-chrome
                browser: chrome

  store-test-reports:
    description: |
      Stores test results using post-steps parameter, see https://on.cypress.io/reporters,
      assumes that reports are saved in folder "cypress/results". Also see [artifacts](#artifacts) parameter.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2

      workflows:
        build:
          jobs:
            - cypress/run:
                post-steps:
                  - store_test_results:
                      path: cypress/results

  env-vars:
    description: |
      Set additional environment variables when running Cypress tests by
      adding them to the executor.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2

      executors:
        base10-foo-bar:
          docker:
            - image: cypress/base:10
          environment:
            FOO: 'foo'
            BAR: 'bar'

      workflows:
        build:
          jobs:
            - cypress/run:
                executor: base10-foo-bar

  custom-command:
    description: Use your own arbitrary command to launch Cypress tests.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                command: npx cypress run --record

  custom-command-prefix:
    description: Use your own arbitrary command to prefix default cypress run test command.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                command-prefix: npx percy exec --

  no-workspace:
    description: |
      Faster "cypress/run" job that does not attach workspace,
      because there are no jobs that follow, so no need to save files.
      This removes the "Persisting to workspace" step of the job.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                no-workspace: true

  private-npm-module:
    description: |
      This example shows how to install private NPM modules using NPM_TOKEN environment
      variable using "pre-steps" parameter. Then it starts the server, waits for it to respond
      and runs Cypress tests. Then it publishes a new version of the current module
      using semantic-release script (using the same NPM_TOKEN variable to publish).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                pre-steps:
                  - run: 'echo "//registry.npmjs.org/:_authToken=${NPM_TOKEN}" > ~/.npmrc'
                no-workspace: true
                start: npm start
                wait-on: 'http://localhost:3003'
                post-steps:
                  - run: npm run semantic-release

  run-tasks-post-checkout:
    description: Perform commands after checkout, but before install
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                post-checkout:
                  - run: echo Scaffolding before installing

  print-info:
    description: |
      It is useful to print information about the OS and found browsers
      using the "cypress info" command
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                post-install:
                  - run: npx cypress info

  install-extra-tool:
    description: |
      Sometimes you want to install another tool after installing regular dependencies
      but before running "cypress verify" and caching NPM modules and Cypress binary.
      In this example, it installs one more tool "print-env" and runs it.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                post-install:
                  - run: npm install -g print-env
                  - run: print-env CIRCLE

  config:
    description: Passing additional Cypress config parameters via --config CLI argument
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                config: pageLoadTimeout=100000,watchForFileChanges=false

  config-file:
    description: Uses non-default configuration file
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                config-file: staging.json

  env:
    description: Passing values via --env CLI argument
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                env: userName=Joe,apiKey=1234567890

  tags:
    description: Pass tags to the dashboard
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                record: true
                tags: nightly,staging

  attach-workspace:
    description: |
      You may run multiple job after installing dependencies once.
      In that case every job should attach workspace and require cypress/install.
      Related parameter [no-workspace](#no-workspace).
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/install
            - cypress/run:
                requires:
                  - cypress/install
                attach-workspace: true

  debug:
    description: |
      To debug Cypress, use DEBUG=... environment variable which works via
      https://github.com/visionmedia/debug NPM module. For example, to debug
      Cypress CLI use "cypress:cli", and to debug everything use "cypress*",
      which could be very verbose.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                name: Debug with Cypress CLI logs
                debug: cypress:cli

  run-on-master-branch:
    description: |
      Sometimes you want to execute only some tests on the "master" branch.
      This recipe shows how to set job filters in the workflow. Development tests job
      runs all the specs on every branch but master. Production tests executes only
      some specs and runs only on "master" branch.
    usage:
      version: 2.1
      orbs:
        cypress: cypress-io/cypress@2
      workflows:
        build:
          jobs:
            - cypress/run:
                name: Development tests
                filters:
                  branches:
                    ignore:
                      - master
            - cypress/run:
                name: Production tests
                spec: 'cypress/integration/prod/*'
                filters:
                  branches:
                    only:
                      - master
##
## Development (internal)
##
## process this workflow using above jobs and commands like inline orb
## Useful for local developing, especially by showing the effective config
## using: npm run effective:config
# workflows:
#   build:
#     jobs:
#       - run:
#           record: true
#           ci-build-id: test-run-commit-$CIRCLE_SHA1
